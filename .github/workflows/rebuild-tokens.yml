name: Rebuild Tokens

on:
  push:
    branches:
      - main
    paths:
      - 'packages/tokens/io/sync/**/*.json'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  rebuild-tokens:
    name: Rebuild Design Tokens
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Rebuild Tokens
        run: pnpm --filter @wyliedog/tokens build

      - name: Check for Changes
        id: check_changes
        run: |
          if git diff --quiet packages/tokens/io/processed/ packages/tokens/dist/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected in processed tokens or dist files"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in processed tokens or dist files"
          fi

      - name: Commit Rebuilt Tokens
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add packages/tokens/io/processed/ packages/tokens/dist/
          git commit -m "chore: rebuild tokens from Figma sync" \
            -m "Automatically rebuilt design tokens after changes to io/sync files." \
            -m "ðŸ¤– Generated by GitHub Actions"
          git push
